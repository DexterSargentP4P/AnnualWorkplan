<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Plan Dashboard - Funder Deliverables & Gantt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-on-track-dot { background-color: #22c55e; }
        .status-at-risk-dot { background-color: #facc15; }
        .status-off-track-dot { background-color: #ef4444; }
        .status-completed-dot, .status-approved-dot { background-color: #3b82f6; }
        .status-not-started-dot { background-color: #9ca3af; }
        .status-submitted-dot { background-color: #a855f7; }
        .status-overdue-dot { background-color: #fbbf24; }
        .status-in-progress-dot { background-color: #60a5fa; }

        .progress-bar-bg { background-color: #e5e7eb; border-radius: 0.375rem; height: 1rem; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease-in-out; text-align: center; color: white; font-size: 0.75rem; line-height: 1rem; display: flex; align-items: center; justify-content: center; }
        .progress-on-track { background-color: #22c55e; }
        .progress-at-risk { background-color: #facc15; }
        .progress-off-track { background-color: #ef4444; }
        .progress-completed { background-color: #3b82f6; }
        .progress-not-started { background-color: #9ca3af; }

        .error-message { color: #ef4444; font-weight: bold; margin-top: 10px; }
        .info-message { color: #3b82f6; font-style: italic; margin-top: 10px; }
        .loading-message { color: #6b7280; font-style: italic; margin-top: 10px; }

        .priority-group { margin-bottom: 2.5rem; }
        .priority-title { font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 1rem; padding: 1rem; background-color: #e5e7eb; border-radius: 0.5rem; }
        .objective-group { margin-left: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background-color: #f9fafb; border-radius: 0.5rem; border-left-width: 4px; }
        .objective-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #d1d5db; }
        
        .strategy-card { background-color: #ffffff; }

        .gantt-container .grid-background { fill: #f9fafb; } .gantt-container .grid-header { fill: #f3f4f6; }
        .gantt-container .grid-row { fill: #ffffff; } .gantt-container .grid-row:nth-child(even) { fill: #f9fafb; }
        .gantt-container .bar-label { fill: #374151; font-size: 12px; cursor: default; } 
        .gantt-container .bar-label.objective-task-label { font-weight: bold; cursor: pointer !important; } 
        .gantt-container .bar-progress { fill-opacity: 0.7; } 
        .gantt-container .bar-wrapper .bar { fill-opacity: 0.3; stroke-width: 0; }
        .gantt-container .objective-task-label .bar { cursor: pointer !important; }
        .gantt-container .handle { fill: #e5e7eb; stroke: #9ca3af; }
        .view-hidden { display: none !important; }

        .form-section { border: 1px solid #e5e7eb; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem; background-color: #f9fafb; }
        .form-section-title { font-weight: 600; margin-bottom: 0.75rem; color: #374151; }
        .input-group { margin-bottom: 0.75rem; }
        .remove-btn { background-color: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
        .remove-btn:hover { background-color: #fecaca; }
        .add-btn { background-color: #dbeafe; color: #1d4ed8; padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 0.25rem; margin-top: 0.5rem; }
        .add-btn:hover { background-color: #bfdbfe; }
        
        .view-switch-btn.active-view { color: #2563eb; border-bottom: 2px solid #2563eb; font-weight: 600; }
        .legend-item { display: flex; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .legend-color-swatch { width: 1rem; height: 1rem; margin-right: 0.5rem; border-radius: 0.125rem; border: 1px solid #ccc; }
        #ganttObjectiveLegendContainer { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        #planObjectiveLegendContainer { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; background-color: #fff; padding:1rem; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        
        /* Gantt Deliverable Separator Bar */
        .gantt .gantt-deliverable-separator .bar { fill: #4b5563 !important; /* gray-600 */ fill-opacity: 1 !important; }
        .gantt .gantt-deliverable-separator .bar-label { fill: #ffffff !important; font-weight: bold; }
        .gantt .gantt-funder-deliverable .bar { fill: #0d9488 !important; /* teal-600 */ fill-opacity: 0.3 !important; }
        .gantt .gantt-funder-deliverable .bar-progress { fill: #0d9488 !important; fill-opacity: 0.7 !important; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-2xl font-bold text-gray-700">Annual Plan Dashboard</h1>
                <nav class="space-x-1">
                    <button data-view="overview" class="view-switch-btn text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Overview</button>
                    <button data-view="plan" class="view-switch-btn text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Strategic Plan</button>
                    <button data-view="gantt" class="view-switch-btn text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Gantt Chart</button>
                    <button data-view="deliverables" class="view-switch-btn text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Funder Deliverables</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-8">

        <section id="overview-view" class="view-section bg-white p-6 rounded-lg shadow-lg">
             <h2 class="text-xl font-semibold text-gray-700 mb-2">Overall Progress Summary</h2>
            <p class="text-sm text-gray-500 mb-4">Summary metrics are calculated from loaded plan items and funder deliverables.</p>
            <div id="scorecardSummaryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                <div class="bg-blue-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-blue-700">Plan Items On Track</h3><p class="text-3xl font-bold text-blue-600" id="summaryGoalsOnTrack">--/--</p></div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-yellow-700">Items At Risk</h3><p class="text-3xl font-bold text-yellow-600" id="summaryItemsAtRisk">--</p></div>
                <div class="bg-red-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-red-700">Critical Issues (Off Track)</h3><p class="text-3xl font-bold text-red-600" id="summaryCriticalIssues">--</p></div>
                <div class="bg-green-50 p-4 rounded-lg shadow"><h3 class="text-sm font-medium text-green-700">Items Completed</h3><p class="text-3xl font-bold text-green-600" id="summaryItemsCompleted">--</p></div>
            </div>
        </section>

        <section id="plan-view" class="view-section space-y-8 view-hidden"> 
            <div id="add-plan-item-section" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Strategic Priority (In-Memory)</h2>
                <form id="addPlanForm" class="space-y-4">
                    <div class="input-group">
                        <label for="strategicPriorityTitle" class="block text-sm font-medium text-gray-700">Strategic Priority Title:</label>
                        <input type="text" id="strategicPriorityTitle" name="strategicPriorityTitle" required placeholder="E.g., Organizational Excellence" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div id="objectivesContainer" class="space-y-4"></div>
                    <button type="button" id="addObjectiveBtn" class="add-btn">Add Objective (Max 3)</button>
                    <hr class="my-6"><button type="submit" class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 text-white font-medium text-sm leading-tight uppercase rounded-md shadow-md hover:bg-blue-700 hover:shadow-lg focus:bg-blue-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-blue-800 active:shadow-lg transition duration-150 ease-in-out">Add Entire Strategic Priority to Plan</button>
                </form>
            </div>

            <div id="strategic-plan-list-section" class="p-0">
                <div class="flex justify-between items-center mb-2 bg-white p-6 rounded-t-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-700">Strategic Plan Details</h2>
                </div>
                <div id="planObjectiveLegendContainer" class="bg-white px-6 pt-2 pb-4 shadow-lg rounded-b-lg mb-6">
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Objective Legend (Plan View):</h4>
                    <div id="planObjectiveLegend" class="flex flex-wrap gap-x-4 gap-y-2"></div>
                </div>
                <div id="errorDisplayPlan" class="error-message bg-white px-6"></div>
                <div id="loadingDisplayPlan" class="loading-message bg-white px-6 pb-6">Loading plan items...</div>
                <div id="planListContainer" class="space-y-0"></div>
            </div>
        </section>

        <section id="gantt-view" class="view-section view-hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Gantt Chart View</h2>
            <p class="text-sm text-gray-500 mb-4">Visual timeline of plan items & deliverables. Click on an Objective bar to expand/collapse. Items must have a timeline (quarter) assigned.</p>
            <div id="ganttObjectiveLegendContainer" class="mb-4">
                 <h4 class="text-sm font-semibold text-gray-600 mb-2">Legend (Gantt View):</h4>
                 <div id="ganttCombinedLegend" class="flex flex-wrap gap-x-4 gap-y-2"></div>
            </div>
            <div id="ganttErrorDisplay" class="error-message"></div>
            <div id="ganttChartContainer" class="gantt-container min-h-[400px]"><svg id="gantt"></svg></div>
        </section>

        <section id="deliverables-view" class="view-section view-hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Funder Deliverables</h2>
            <div id="add-deliverable-section" class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Add New Funder Deliverable (In-Memory)</h3>
                <form id="addDeliverableForm" class="space-y-4 bg-gray-50 p-4 rounded-md border">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="deliverableTitle" class="block text-sm font-medium text-gray-700">Deliverable Title/Name:</label>
                            <input type="text" id="deliverableTitle" name="deliverableTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="deliverableFunder" class="block text-sm font-medium text-gray-700">Funder:</label>
                            <input type="text" id="deliverableFunder" name="deliverableFunder" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label for="deliverableProject" class="block text-sm font-medium text-gray-700">Associated Project/Grant (Optional):</label>
                        <input type="text" id="deliverableProject" name="deliverableProject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="deliverableTimelineQuarter" class="block text-sm font-medium text-gray-700">Due (Quarter):</label>
                            <select id="deliverableTimelineQuarter" name="deliverableTimelineQuarter" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </select>
                        </div>
                        <div>
                            <label for="deliverableStatus" class="block text-sm font-medium text-gray-700">Status:</label>
                            <select id="deliverableStatus" name="deliverableStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>Not Started</option> <option>In Progress</option> <option>Submitted</option>
                                <option>Approved</option> <option>Overdue</option> <option>Completed</option> 
                            </select>
                        </div>
                        <div>
                            <label for="deliverableResponsible" class="block text-sm font-medium text-gray-700">Responsible:</label>
                            <input type="text" id="deliverableResponsible" name="deliverableResponsible" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label for="deliverableNotes" class="block text-sm font-medium text-gray-700">Notes:</label>
                        <textarea id="deliverableNotes" name="deliverableNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                    <button type="submit" class="px-6 py-2.5 bg-green-600 text-white font-medium text-sm leading-tight uppercase rounded-md shadow-md hover:bg-green-700 hover:shadow-lg focus:bg-green-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-green-800 active:shadow-lg transition duration-150 ease-in-out">
                        Add Deliverable
                    </button>
                </form>
            </div>
            <div id="errorDisplayDeliverables" class="error-message"></div>
            <div id="loadingDisplayDeliverables" class="loading-message">Loading funder deliverables...</div>
            <div id="funderDeliverablesTableContainer" class="overflow-x-auto">
                </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; <span id="currentYear"></span> Your Organization. All rights reserved.</p>
    </footer>

    <script>
        let strategicPlanData = [
            { id: 'yr1_ci_obj1_act1', strategicPriority: 'Enhance Community Engagement & Impact (Year 1)', objective: 'Expand Program Reach & Accessibility', title: 'Launch Pilot Program in Underserved Area X', description: 'Conduct needs assessment, adapt program materials, and initiate pilot phase for 50 new beneficiaries.', status: 'On Track', progress: 25, timeline: 'Q1 2025', responsible: 'Program Team Lead' },
            { id: 'yr1_ci_obj1_act2', strategicPriority: 'Enhance Community Engagement & Impact (Year 1)', objective: 'Expand Program Reach & Accessibility', title: 'Develop Online Resource Portal', description: 'Create a web portal with accessible program information, resources, and application forms.', status: 'Not Started', progress: 0, timeline: 'Q2 2025', responsible: 'IT & Comms Team' },
            { id: 'yr1_ci_obj1_act3', strategicPriority: 'Enhance Community Engagement & Impact (Year 1)', objective: 'Expand Program Reach & Accessibility', title: 'Establish 2 New Community Partnerships', description: 'Identify and formalize partnerships with local organizations to improve referral pathways.', status: 'At Risk', progress: 10, timeline: 'Q3 2025', responsible: 'Outreach Coordinator' },
            { id: 'yr1_ci_obj2_act1', strategicPriority: 'Enhance Community Engagement & Impact (Year 1)', objective: 'Strengthen Volunteer Program', title: 'Recruit & Onboard 20 New Volunteers', description: 'Develop targeted recruitment campaign and streamline onboarding process.', status: 'On Track', progress: 60, timeline: 'Q1 2025', responsible: 'Volunteer Coordinator' },
            { id: 'yr1_ci_obj2_act2', strategicPriority: 'Enhance Community Engagement & Impact (Year 1)', objective: 'Strengthen Volunteer Program', title: 'Implement Volunteer Recognition Program', description: 'Design and launch a program to acknowledge and appreciate volunteer contributions.', status: 'Completed', progress: 100, timeline: 'Q2 2025', responsible: 'Volunteer Coordinator' },
            { id: 'yr1_oe_obj1_act1', strategicPriority: 'Organizational Excellence & Sustainability (Year 1)', objective: 'Improve Operational Efficiency', title: 'Implement Phase 1 of New CRM System', description: 'Core module setup, data migration planning for CRM.', status: 'On Track', progress: 40, timeline: 'Q3 2025', responsible: 'IT Manager, Ops Lead' },
            { id: 'yr1_oe_obj1_act2', strategicPriority: 'Organizational Excellence & Sustainability (Year 1)', objective: 'Improve Operational Efficiency', title: 'Streamline Financial Reporting Processes', description: 'Review and optimize monthly and quarterly financial reporting procedures.', status: 'Completed', progress: 100, timeline: 'Q1 2025', responsible: 'Finance Director' },
            { id: 'yr1_oe_obj2_act1', strategicPriority: 'Organizational Excellence & Sustainability (Year 1)', objective: 'Enhance Staff Development & Wellbeing', title: 'Conduct Annual Staff Satisfaction Survey', description: 'Administer survey, analyze results, and develop action plan.', status: 'Not Started', progress: 0, timeline: 'Q2 2025', responsible: 'HR Manager' },
            { id: 'yr1_oe_obj2_act2', strategicPriority: 'Organizational Excellence & Sustainability (Year 1)', objective: 'Enhance Staff Development & Wellbeing', title: 'Launch Mentorship Program Pilot', description: 'Pair 5 senior and junior staff for initial pilot phase.', status: 'At Risk', progress: 5, timeline: 'Q4 2025', responsible: 'HR Manager' },
            { id: 'yr1_ifr_obj1_act1', strategicPriority: 'Innovation & Future Readiness (Year 1)', objective: 'Explore New Programmatic Areas', title: 'Research Emerging Community Needs', description: 'Conduct environmental scan and stakeholder interviews to identify potential new service areas.', status: 'On Track', progress: 15, timeline: 'Q4 2025', responsible: 'Research Lead' },
            { id: 'yr2_ci_obj1_act1', strategicPriority: 'Enhance Community Engagement & Impact (Year 2)', objective: 'Expand Program Reach & Accessibility (Y2)', title: 'Scale Pilot Program in Area X', description: 'Expand successful pilot to 200 beneficiaries.', status: 'Not Started', progress: 0, timeline: 'Q1 2026', responsible: 'Program Team Lead' },
            { id: 'yr2_oe_obj1_act1', strategicPriority: 'Organizational Excellence & Sustainability (Year 2)', objective: 'Improve Operational Efficiency (Y2)', title: 'CRM System Full Rollout & Training', description: 'Complete data migration and train all relevant staff.', status: 'Not Started', progress: 0, timeline: 'Q2 2026', responsible: 'IT Manager' },
            { id: 'yr2_ifr_obj1_act1', strategicPriority: 'Innovation & Future Readiness (Year 2)', objective: 'Explore New Programmatic Areas (Y2)', title: 'Develop 1 Pilot Proposal for New Service', description: 'Based on Year 1 research, develop a detailed proposal for a new pilot initiative.', status: 'Not Started', progress: 0, timeline: 'Q2 2026', responsible: 'Program Development' }
        ];
        
        let funderDeliverablesData = [
            { id: 'fd_lfo_report1', title: 'Qualitative Survey Summary Report', funder: 'Law Foundation of Ontario', project: 'Safe & Secure Evergreen', timeline: 'Q4 2025', status: 'In Progress', responsible: 'Project Manager', notes: 'Based on outreach to 200 families.' },
            { id: 'fd_lfo_review', title: 'Legal Review of Workbook', funder: 'Law Foundation of Ontario', project: 'Safe & Secure Evergreen', timeline: 'Q2 2026', status: 'Not Started', responsible: 'Legal Advisor (PooranLaw)', notes: 'Final review of evergreen content.'},
            { id: 'fd_ktt_module1', title: 'Mental Health Resources Module', funder: 'KTT Initiative', project: 'REAL Xchange Content', timeline: 'Q3 2025', status: 'On Track', responsible: 'CLEC', notes: 'Develop, release, and promote.'},
            { id: 'fd_ktt_webcast1', title: 'Webcast on Journey to Belonging Updates', funder: 'KTT Initiative', project: 'REAL Xchange Promotion', timeline: 'Q4 2025', status: 'Not Started', responsible: 'P4P', notes: 'In partnership with MCCSS.'},
            { id: 'fd_esdc_report_q1', title: 'ESDC Q1 Progress Report', funder: 'ESDC', project: 'National Facilitator Collaborative', timeline: 'Q1 2025', status: 'Submitted', responsible: 'National Coordinator', notes: 'Covering Jan-Mar activities.'},
            { id: 'fd_esdc_report_q2', title: 'ESDC Q2 Financial Statement', funder: 'ESDC', project: 'National Facilitator Collaborative', timeline: 'Q2 2025', status: 'Not Started', responsible: 'Finance Dept', notes: 'Detailed financial expenditure.'}
        ];

        let ganttChart = null;
        let objectiveCounter = 0;
        let strategyCounter = 0;
        let objectiveColors = {}; 
        const predefinedColorClasses = [ 
            { planClass: 'border-red-500', ganttFill: '#EF4444' }, { planClass: 'border-orange-500', ganttFill: '#F97316' },
            { planClass: 'border-amber-500', ganttFill: '#F59E0B' }, { planClass: 'border-yellow-500', ganttFill: '#EAB308' },
            { planClass: 'border-lime-500', ganttFill: '#84CC16' }, { planClass: 'border-green-500', ganttFill: '#22C55E' },
            { planClass: 'border-emerald-500', ganttFill: '#10B981' }, { planClass: 'border-teal-500', ganttFill: '#14B8A6' },
            { planClass: 'border-cyan-500', ganttFill: '#06B6D4' }, { planClass: 'border-sky-500', ganttFill: '#0EA5E9' },
            { planClass: 'border-blue-500', ganttFill: '#3B82F6' }, { planClass: 'border-indigo-500', ganttFill: '#6366F1' },
            { planClass: 'border-violet-500', ganttFill: '#8B5CF6' }, { planClass: 'border-purple-500', ganttFill: '#A855F7' },
            { planClass: 'border-fuchsia-500', ganttFill: '#D946EF' }, { planClass: 'border-pink-500', ganttFill: '#EC4899' },
            { planClass: 'border-rose-500', ganttFill: '#F43F5E' }
        ];
        const funderDeliverableGanttColor = { planClass: 'border-slate-500', ganttFill: '#64748B' }; // Slate for deliverables
        let colorIndex = 0;
        let expandedObjectives = {}; 

        const planListContainerElement = document.getElementById('planListContainer');
        const addPlanFormElement = document.getElementById('addPlanForm');
        const objectivesContainerElement = document.getElementById('objectivesContainer');
        const addObjectiveBtnElement = document.getElementById('addObjectiveBtn');
        
        const errorDisplayPlanElement = document.getElementById('errorDisplayPlan');
        const loadingDisplayPlanElement = document.getElementById('loadingDisplayPlan');
        const currentYearElement = document.getElementById('currentYear');
        
        const summaryGoalsOnTrackEl = document.getElementById('summaryGoalsOnTrack');
        const summaryItemsAtRiskEl = document.getElementById('summaryItemsAtRisk');
        const summaryCriticalIssuesEl = document.getElementById('summaryCriticalIssues');
        const summaryItemsCompletedEl = document.getElementById('summaryItemsCompleted');

        const ganttSvgElement = document.getElementById('gantt');
        const ganttErrorDisplayElement = document.getElementById('ganttErrorDisplay');
        const viewSwitchButtons = document.querySelectorAll('.view-switch-btn');
        const viewSections = document.querySelectorAll('.view-section');
        const planObjectiveLegendElement = document.getElementById('planObjectiveLegend');
        const ganttCombinedLegendElement = document.getElementById('ganttCombinedLegend'); // Updated ID for combined legend

        const addDeliverableFormElement = document.getElementById('addDeliverableForm');
        const funderDeliverablesTableContainerElement = document.getElementById('funderDeliverablesTableContainer');
        const errorDisplayDeliverablesElement = document.getElementById('errorDisplayDeliverables');
        const loadingDisplayDeliverablesElement = document.getElementById('loadingDisplayDeliverables');
        const deliverableTimelineQuarterElement = document.getElementById('deliverableTimelineQuarter');


        function displayMessage(element, message, type = 'info') {
            if (!element) return;
            element.textContent = message;
            element.className = 'mt-2 text-sm '; 
            if (type === 'error') element.classList.add('error-message');
            else if (type === 'loading') element.classList.add('loading-message');
            else element.classList.add('info-message');
            element.style.display = message ? 'block' : 'none';
        }
        
        function getStatusColorClasses(statusString) {
            const status = typeof statusString === 'string' ? statusString.toLowerCase().trim() : 'not started';
            if (status.includes('on track')) return { dot: 'status-on-track-dot', textBg: 'bg-green-100 text-green-700', progress: 'progress-on-track' };
            if (status.includes('in progress')) return { dot: 'status-in-progress-dot', textBg: 'bg-blue-100 text-blue-700', progress: 'progress-not-started' };
            if (status.includes('at risk') || status.includes('potential issue')) return { dot: 'status-at-risk-dot', textBg: 'bg-yellow-100 text-yellow-700', progress: 'progress-at-risk' };
            if (status.includes('off track') || status.includes('behind') || status.includes('significant issue')) return { dot: 'status-off-track-dot', textBg: 'bg-red-100 text-red-700', progress: 'progress-off-track' };
            if (status.includes('completed') || status.includes('done') || status.includes('achieved')) return { dot: 'status-completed-dot', textBg: 'bg-blue-100 text-blue-700', progress: 'progress-completed' };
            if (status.includes('submitted')) return { dot: 'status-submitted-dot', textBg: 'bg-purple-100 text-purple-700', progress: 'progress-not-started'};
            if (status.includes('approved')) return { dot: 'status-approved-dot', textBg: 'bg-sky-100 text-sky-700', progress: 'progress-completed'};
            if (status.includes('overdue')) return { dot: 'status-overdue-dot', textBg: 'bg-amber-100 text-amber-700', progress: 'progress-at-risk'};
            return { dot: 'status-not-started-dot', textBg: 'bg-gray-100 text-gray-700', progress: 'progress-not-started' };
        }
        
        function getDatesFromQuarter(quarterString) {
            if (!quarterString || !quarterString.includes('Q') || !quarterString.includes(' ')) {
                return { start: null, end: null };
            }
            const parts = quarterString.split(' ');
            const quarter = parseInt(parts[0].substring(1));
            const year = parseInt(parts[1]);

            if (isNaN(quarter) || isNaN(year) || quarter < 1 || quarter > 4) {
                 return { start: null, end: null };
            }

            let startDate, endDate;
            switch (quarter) {
                case 1: startDate = `${year}-01-01`; endDate = `${year}-03-31`; break;
                case 2: startDate = `${year}-04-01`; endDate = `${year}-06-30`; break;
                case 3: startDate = `${year}-07-01`; endDate = `${year}-09-30`; break;
                case 4: startDate = `${year}-10-01`; endDate = `${year}-12-31`; break;
                default: return { start: null, end: null };
            }
            return { start: startDate, end: endDate };
        }

        function populateTimelineDropdown(selectElement) {
            const currentYr = new Date().getFullYear();
            const quarters = ["Q1", "Q2", "Q3", "Q4"];
            selectElement.innerHTML = '<option value="">Select Quarter</option>';
            for (let i = 0; i < 3; i++) { 
                const year = currentYr + i;
                quarters.forEach(q => {
                    const option = document.createElement('option');
                    option.value = `${q} ${year}`;
                    option.textContent = `${q} ${year}`;
                    selectElement.appendChild(option);
                });
            }
        }

        function createStrategyElement(objectiveIndex) {
            strategyCounter++;
            const strategyDiv = document.createElement('div');
            strategyDiv.className = 'form-section ml-4';
            strategyDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="form-section-title">Strategy/Key Activity</p>
                    <button type="button" class="remove-btn remove-strategy-btn">Remove Strategy</button>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700">Strategy/Activity Title:</label>
                    <input type="text" name="strategyTitle_${objectiveIndex}_${strategyCounter}" required placeholder="E.g., Develop marketing materials" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700">Description:</label>
                    <textarea name="strategyDescription_${objectiveIndex}_${strategyCounter}" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700">Status:</label>
                        <select name="strategyStatus_${objectiveIndex}_${strategyCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-sm">
                            <option>Not Started</option><option>On Track</option><option>At Risk</option><option>Off Track</option><option>Completed</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700">Progress (%):</label>
                        <input type="number" name="strategyProgress_${objectiveIndex}_${strategyCounter}" value="0" min="0" max="100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700">Timeline (Quarter):</label>
                        <select name="strategyTimeline_${objectiveIndex}_${strategyCounter}" class="strategy-timeline-select mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm text-sm"></select>
                    </div>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700">Responsible:</label>
                    <input type="text" name="strategyResponsible_${objectiveIndex}_${strategyCounter}" placeholder="E.g., Marketing Team" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
            `;
            populateTimelineDropdown(strategyDiv.querySelector('.strategy-timeline-select'));
            strategyDiv.querySelector('.remove-strategy-btn').addEventListener('click', () => strategyDiv.remove());
            return strategyDiv;
        }

        function createObjectiveElement() {
            objectiveCounter++;
            const objectiveDiv = document.createElement('div');
            objectiveDiv.className = 'form-section';
            objectiveDiv.dataset.objectiveIndex = objectiveCounter; 
            objectiveDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h4 class="form-section-title">Objective</h4>
                    <button type="button" class="remove-btn remove-objective-btn">Remove Objective</button>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700">Objective Title:</label>
                    <input type="text" name="objectiveTitle_${objectiveCounter}" required placeholder="E.g., Increase Volunteer Participation" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                </div>
                <div class="strategies-container space-y-3 mt-3"></div>
                <button type="button" class="add-btn add-strategy-btn">Add Strategy/Activity (Max 3)</button>
            `;
            
            const strategiesContainer = objectiveDiv.querySelector('.strategies-container');
            const addStrategyBtn = objectiveDiv.querySelector('.add-strategy-btn');

            addStrategyBtn.addEventListener('click', () => {
                if (strategiesContainer.children.length < 3) {
                    strategiesContainer.appendChild(createStrategyElement(objectiveCounter));
                } else {
                    alert('Maximum of 3 strategies/activities per objective.');
                }
            });
            objectiveDiv.querySelector('.remove-objective-btn').addEventListener('click', () => objectiveDiv.remove());
            strategiesContainer.appendChild(createStrategyElement(objectiveCounter)); 
            return objectiveDiv;
        }
        
        function assignObjectiveColors() {
            objectiveColors = {}; 
            colorIndex = 0;
            const objectives = [...new Set(strategicPlanData.map(item => item.objective).filter(Boolean))];
            objectives.forEach(objective => {
                if (!objectiveColors[objective]) {
                    objectiveColors[objective] = predefinedColorClasses[colorIndex % predefinedColorClasses.length];
                    colorIndex++;
                }
            });
        }

        function renderStrategicPlan() {
            planListContainerElement.innerHTML = '';
            assignObjectiveColors(); 
            displayMessage(loadingDisplayPlanElement, strategicPlanData.length > 0 ? '' : 'No plan items loaded. Use the form above to add items.', strategicPlanData.length > 0 ? 'info' : 'loading');

            const groupedByPriority = strategicPlanData.reduce((acc, item) => {
                const priority = item.strategicPriority || 'Uncategorized Priorities';
                if (!acc[priority]) acc[priority] = [];
                acc[priority].push(item);
                return acc;
            }, {});

            for (const priorityName in groupedByPriority) {
                const priorityDiv = document.createElement('div');
                priorityDiv.className = 'priority-group';
                priorityDiv.innerHTML = `<h2 class="priority-title">${priorityName}</h2>`;
                
                const groupedByObjective = groupedByPriority[priorityName].reduce((acc, item) => {
                    const objective = item.objective || 'General Activities';
                    if (!acc[objective]) acc[objective] = [];
                    acc[objective].push(item);
                    return acc;
                }, {});

                for (const objectiveName in groupedByObjective) {
                    const objectiveItems = groupedByObjective[objectiveName];
                    const objectiveColorInfo = objectiveColors[objectiveName] || { planClass: 'border-gray-300' };
                    
                    const objectiveGroupDiv = document.createElement('div');
                    objectiveGroupDiv.className = `objective-group ${objectiveColorInfo.planClass}`; 
                    objectiveGroupDiv.innerHTML = `<h3 class="objective-title">${objectiveName}</h3>`;
                    
                    const strategiesContainer = document.createElement('div');
                    strategiesContainer.className = 'space-y-6';

                    objectiveItems.forEach(item => {
                        const statusColorInfo = getStatusColorClasses(item.status);
                        const itemCardHTML = `
                            <div class="strategy-card bg-white p-5 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-300">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="text-md font-semibold text-gray-800">${item.title}</h4>
                                    <span class="flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColorInfo.textBg}">
                                        <span class="status-indicator ${statusColorInfo.dot} mr-1.5"></span>
                                        ${item.status}
                                    </span>
                                </div>
                                ${item.description ? `<p class="text-sm text-gray-600 mb-1"><strong>Details:</strong> ${item.description}</p>` : ''}
                                ${item.responsible ? `<p class="text-sm text-gray-500 mb-1"><strong>Responsible:</strong> ${item.responsible}</p>` : ''}
                                ${item.timeline ? `<p class="text-sm text-gray-500 mb-3"><strong>Timeline:</strong> ${item.timeline}</p>` : '<div class="mb-3"></div>'}
                                <div class="mb-3">
                                    <div class="flex justify-between text-xs text-gray-500 mb-1"><span>Progress</span><span>${item.progress}%</span></div>
                                    <div class="progress-bar-bg"><div class="progress-bar ${statusColorInfo.progress}" style="width: ${item.progress}%;">${item.progress > 10 ? item.progress + '%' : ''}</div></div>
                                </div>
                                <div class="mt-4 flex space-x-2 justify-end">
                                    <button class="delete-item-btn text-xs bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-3 rounded-md transition" data-id="${item.id}">Delete</button>
                                </div>
                            </div>`;
                        strategiesContainer.innerHTML += itemCardHTML;
                    });
                    objectiveGroupDiv.appendChild(strategiesContainer);
                    priorityDiv.appendChild(objectiveGroupDiv);
                }
                planListContainerElement.appendChild(priorityDiv);
            }

            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', (event) => deletePlanItemFromMemory(event.target.dataset.id));
            });
        }
        
        function renderObjectiveLegend(legendElement) {
            legendElement.innerHTML = '';
            if (Object.keys(objectiveColors).length === 0 && legendElement.id !== 'ganttCombinedLegend') { // Don't show if no objectives for plan view
                 legendElement.innerHTML = '<p class="text-xs text-gray-500">No objectives with assigned colors yet.</p>';
                 return;
            }
            
            // For combined Gantt legend
            if (legendElement.id === 'ganttCombinedLegend') {
                // Add Objective Colors
                for (const objectiveName in objectiveColors) {
                    const colorInfo = objectiveColors[objectiveName];
                    const swatchColor = colorInfo.ganttFill;
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<span class="legend-color-swatch" style="background-color: ${swatchColor};"></span><span>${objectiveName} (Objective)</span>`;
                    legendElement.appendChild(legendItem);
                }
                // Add Funder Deliverable Color
                const deliverableLegendItem = document.createElement('div');
                deliverableLegendItem.className = 'legend-item';
                deliverableLegendItem.innerHTML = `<span class="legend-color-swatch" style="background-color: ${funderDeliverableGanttColor.ganttFill};"></span><span>Funder Deliverable</span>`;
                legendElement.appendChild(deliverableLegendItem);

                if (Object.keys(objectiveColors).length === 0 && funderDeliverablesData.filter(d => d.timeline).length === 0) {
                    legendElement.innerHTML = '<p class="text-xs text-gray-500">No items with assigned colors for Gantt legend.</p>';
                }

            } else { // For Plan View Legend (only objectives)
                 for (const objectiveName in objectiveColors) {
                    const colorInfo = objectiveColors[objectiveName];
                    const swatchColorClass = colorInfo.planClass.replace('border-','bg-');
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<span class="legend-color-swatch ${swatchColorClass}"></span><span>${objectiveName}</span>`;
                    legendElement.appendChild(legendItem);
                }
            }
        }
        
        function renderGanttChart() {
            displayMessage(ganttErrorDisplayElement, '', 'info'); 
            ganttSvgElement.innerHTML = ''; 
            assignObjectiveColors(); 

            let tasksForGantt = [];
            const uniqueObjectives = [...new Set(strategicPlanData.map(item => item.objective).filter(Boolean))];

            uniqueObjectives.forEach(objName => {
                const objectiveColorInfo = objectiveColors[objName] || { ganttFill: '#D1D5DB' }; 
                const objectiveColorClassName = `gantt-obj-color-${Object.keys(objectiveColors).indexOf(objName)}`;
                const isExpanded = expandedObjectives[objName] === true;

                let objectiveYear = new Date().getFullYear(); 
                const strategiesForObjective = strategicPlanData.filter(item => item.objective === objName && item.timeline);
                if (strategiesForObjective.length > 0) {
                    const years = strategiesForObjective.map(s => parseInt(s.timeline.split(' ')[1]));
                    if (years.length > 0 && !years.some(isNaN)) objectiveYear = Math.min(...years); 
                }
                
                tasksForGantt.push({
                    id: `OBJECTIVE_${objName.replace(/\s+/g, '_')}`, 
                    name: (isExpanded ? '▼ ' : '► ') + objName,
                    start: `${objectiveYear}-01-01`,
                    end: `${objectiveYear}-12-31`,
                    progress: Math.round(strategiesForObjective.reduce((sum, s) => sum + s.progress, 0) / (strategiesForObjective.length || 1)),
                    custom_class: `${objectiveColorClassName} objective-task-label`, 
                    isObjective: true, 
                    objectiveName: objName 
                });

                if (isExpanded) {
                    strategiesForObjective.forEach(item => {
                        const dates = getDatesFromQuarter(item.timeline);
                        if (dates.start && dates.end) {
                            tasksForGantt.push({
                                id: String(item.id), 
                                name: `    ${item.title}`, 
                                start: dates.start,
                                end: dates.end,
                                progress: item.progress,
                                dependencies: `OBJECTIVE_${objName.replace(/\s+/g, '_')}`, 
                                custom_class: objectiveColorClassName 
                            });
                        }
                    });
                }
            });

            // Add Funder Deliverables Separator and Tasks
            if (funderDeliverablesData.some(d => d.timeline)) {
                 tasksForGantt.push({
                    id: 'FUNDER_DELIVERABLES_SEPARATOR',
                    name: '--- FUNDER DELIVERABLES ---',
                    start: `${new Date().getFullYear()}-01-01`, // Spans current year by default
                    end: `${new Date().getFullYear()}-12-31`,
                    progress: 0,
                    custom_class: 'gantt-deliverable-separator',
                    isSeparator: true // Custom flag
                });

                funderDeliverablesData.forEach(deliverable => {
                    const dates = getDatesFromQuarter(deliverable.timeline);
                    if (dates.start && dates.end) {
                        tasksForGantt.push({
                            id: `DELIVERABLE_${deliverable.id}`,
                            name: deliverable.title,
                            start: dates.start,
                            end: dates.end,
                            progress: (deliverable.status || '').toLowerCase().includes('completed') || (deliverable.status || '').toLowerCase().includes('approved') ? 100 : 0, // Simple progress for deliverables
                            custom_class: 'gantt-funder-deliverable' // Specific class for deliverable bars
                        });
                    }
                });
            }


            if (tasksForGantt.length === 0) { // If no objectives and no deliverables with timeline
                 displayMessage(ganttErrorDisplayElement, 'No items with valid timelines to display in Gantt chart.', 'info');
            }
            
            renderObjectiveLegend(ganttCombinedLegendElement); // Render combined legend

            if (tasksForGantt.length === 0) return; // Exit if nothing to draw

            const styleId = 'gantt-dynamic-objective-styles';
            let dynamicStyles = document.getElementById(styleId);
            if (!dynamicStyles) {
                dynamicStyles = document.createElement('style');
                dynamicStyles.id = styleId;
                document.head.appendChild(dynamicStyles);
            }
            let cssRules = '';
            Object.keys(objectiveColors).forEach((objective, index) => {
                const colorHex = objectiveColors[objective].ganttFill;
                const className = `gantt-obj-color-${index}`;
                cssRules += `.gantt .${className}.objective-task-label .bar { cursor: pointer !important; fill: ${colorHex} !important; fill-opacity: 0.3 !important; } `;
                cssRules += `.gantt .${className} .bar-progress { fill: ${colorHex} !important; fill-opacity: 0.7 !important; } `;
                cssRules += `.gantt .${className}:not(.objective-task-label) .bar { fill: ${colorHex} !important; fill-opacity: 0.3 !important; } `;
            });
            dynamicStyles.innerHTML = cssRules;

            try {
                ganttChart = new Gantt("#gantt", tasksForGantt, {
                    header_height: 60, column_width: 30, step: 24,
                    view_modes: ['Quarter Day', 'Week', 'Month', 'Year'], 
                    bar_height: 25, bar_corner_radius: 4, arrow_curve: 5, padding: 20,
                    view_mode: 'Month', date_format: 'YYYY-MM-DD', language: 'en', 
                    on_click: function (task) {
                        if (task.isObjective) { 
                            expandedObjectives[task.objectiveName] = !expandedObjectives[task.objectiveName];
                            renderGanttChart(); 
                        }
                    },
                    custom_popup_html: function(task) {
                        const planItem = strategicPlanData.find(p => String(p.id) === task.id || `OBJECTIVE_${p.objective.replace(/\s+/g, '_')}` === task.id);
                        const deliverableItem = funderDeliverablesData.find(d => `DELIVERABLE_${d.id}` === task.id);

                        if (task.isObjective) {
                             return `
                            <div class="gantt-popup-content p-3 shadow-xl rounded-md bg-white text-sm max-w-xs">
                                <div class="font-bold text-gray-800 mb-1.5">${task.name.replace(/^[▼►]\s*/, '')}</div>
                                <div class="text-xs text-gray-500">Progress: ${task.progress}%</div>
                                <div class="text-xs text-gray-500 mt-1">Click to expand/collapse strategies.</div>
                            </div>`;
                        } else if (deliverableItem) {
                             return `
                            <div class="gantt-popup-content p-3 shadow-xl rounded-md bg-white text-sm max-w-xs">
                                <div class="font-bold text-gray-800 mb-1.5">${deliverableItem.title}</div>
                                <div class="text-xs text-gray-600 mb-0.5"><span class="font-semibold">Funder:</span> ${deliverableItem.funder}</div>
                                ${deliverableItem.project ? `<div class="text-xs text-gray-600 mb-1"><span class="font-semibold">Project:</span> ${deliverableItem.project}</div>` : ''}
                                <div class="text-xs text-gray-500">Due: ${deliverableItem.timeline}</div>
                                <div class="text-xs text-gray-500">Status: ${deliverableItem.status}</div>
                                ${deliverableItem.responsible ? `<div class="text-xs text-gray-500">Responsible: ${deliverableItem.responsible}</div>` : ''}
                            </div>`;
                        }
                        // For strategic plan items (strategies/activities)
                        return `
                            <div class="gantt-popup-content p-3 shadow-xl rounded-md bg-white text-sm max-w-xs">
                                <div class="font-bold text-gray-800 mb-1.5">${planItem ? planItem.title : task.name.trim()}</div>
                                ${planItem && planItem.strategicPriority ? `<div class="text-xs text-gray-600 mb-0.5"><span class="font-semibold">Priority:</span> ${planItem.strategicPriority}</div>` : ''}
                                ${planItem && planItem.objective ? `<div class="text-xs text-gray-600 mb-1"><span class="font-semibold">Objective:</span> ${planItem.objective}</div>` : ''}
                                <div class="text-xs text-gray-500">Timeline: ${planItem ? planItem.timeline : 'N/A'}</div>
                                <div class="text-xs text-gray-500">Status: ${planItem ? planItem.status : 'N/A'}</div>
                                <div class="text-xs text-gray-500">Progress: ${task.progress}%</div>
                                ${planItem && planItem.responsible ? `<div class="text-xs text-gray-500">Responsible: ${planItem.responsible}</div>` : ''}
                            </div>`;
                    }
                });
            } catch (e) {
                console.error("Error initializing Gantt chart:", e);
                displayMessage(ganttErrorDisplayElement, `Error creating Gantt chart: ${e.message}`, 'error');
            }
        }
        
        function updateSummaryMetrics() {
            const planItemsOnTrack = strategicPlanData.filter(g => (g.status || '').toLowerCase().includes('on track')).length;
            const planItemsAtRisk = strategicPlanData.filter(g => (g.status || '').toLowerCase().includes('at risk')).length;
            const planItemsOffTrack = strategicPlanData.filter(g => (g.status || '').toLowerCase().includes('off track')).length;
            const planItemsCompleted = strategicPlanData.filter(g => (g.status || '').toLowerCase().includes('completed')).length;
            
            // Consider deliverables in summary too
            const deliverablesAtRisk = funderDeliverablesData.filter(d => (d.status || '').toLowerCase().includes('at risk') || (d.status || '').toLowerCase().includes('overdue')).length;
            const deliverablesOffTrack = funderDeliverablesData.filter(d => (d.status || '').toLowerCase().includes('off track')).length; // Assuming 'Off Track' is a possible deliverable status
            const deliverablesCompleted = funderDeliverablesData.filter(d => (d.status || '').toLowerCase().includes('completed') || (d.status || '').toLowerCase().includes('approved')).length;


            summaryGoalsOnTrackEl.textContent = `${planItemsOnTrack}/${strategicPlanData.length || 0}`;
            summaryItemsAtRiskEl.textContent = `${planItemsAtRisk + deliverablesAtRisk}`;
            summaryCriticalIssuesEl.textContent = `${planItemsOffTrack + deliverablesOffTrack}`;
            summaryItemsCompletedEl.textContent = `${planItemsCompleted + deliverablesCompleted}`;
        }

        function switchView(targetViewId) {
            viewSections.forEach(section => {
                if (section.id === targetViewId + '-view') {
                    section.classList.remove('view-hidden');
                } else {
                    section.classList.add('view-hidden');
                }
            });
            viewSwitchButtons.forEach(button => {
                if (button.dataset.view === targetViewId) {
                    button.classList.add('active-view');
                } else {
                    button.classList.remove('active-view');
                }
            });
            if (targetViewId === 'gantt') {
                setTimeout(() => renderGanttChart(), 0); 
            } else if (targetViewId === 'plan') {
                renderObjectiveLegend(planObjectiveLegendElement);
            } else if (targetViewId === 'deliverables') {
                renderFunderDeliverables();
            }
        }

        viewSwitchButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const viewId = event.currentTarget.dataset.view;
                switchView(viewId);
            });
        });
        
        addPlanFormElement.addEventListener('submit', (event) => {
            event.preventDefault();
            displayMessage(errorDisplayPlanElement, '', 'info');
            const strategicPriorityTitle = document.getElementById('strategicPriorityTitle').value.trim();

            if (!strategicPriorityTitle) {
                displayMessage(errorDisplayPlanElement, 'Strategic Priority Title is required.', 'error');
                return;
            }

            const objectiveElements = objectivesContainerElement.querySelectorAll('.form-section');
            if (objectiveElements.length === 0) {
                displayMessage(errorDisplayPlanElement, 'Please add at least one objective for the priority.', 'error');
                return;
            }
            
            let allValid = true;
            let itemsAddedInThisSubmission = 0;
            objectiveElements.forEach((objEl, objIndexOuter) => {
                if (!allValid) return; 
                const currentObjectiveIndex = objEl.dataset.objectiveIndex; 
                const objectiveTitleInput = objEl.querySelector(`input[name="objectiveTitle_${currentObjectiveIndex}"]`);
                const objectiveTitle = objectiveTitleInput ? objectiveTitleInput.value.trim() : '';

                if (!objectiveTitle) {
                     displayMessage(errorDisplayPlanElement, `Title for an Objective is required.`, 'error');
                     allValid = false; return;
                }

                const strategyElements = objEl.querySelectorAll('.form-section.ml-4');
                if (strategyElements.length === 0) {
                    displayMessage(errorDisplayPlanElement, `Please add at least one strategy for Objective: ${objectiveTitle}.`, 'error');
                    allValid = false; return;
                }
                
                strategyElements.forEach((stratEl, stratIndex) => {
                    if (!allValid) return;
                    const strategyTitleInput = stratEl.querySelector(`input[name^="strategyTitle_${currentObjectiveIndex}_"]`);
                    const strategyTitle = strategyTitleInput ? strategyTitleInput.value.trim() : '';

                    if (!strategyTitle) {
                        displayMessage(errorDisplayPlanElement, `Title for a Strategy under Objective: ${objectiveTitle} is required.`, 'error');
                        allValid = false; return;
                    }

                    const newItem = {
                        id: `manual-item-${Date.now()}-${objIndexOuter}-${stratIndex}`,
                        strategicPriority: strategicPriorityTitle,
                        objective: objectiveTitle,
                        title: strategyTitle,
                        description: stratEl.querySelector(`textarea[name^="strategyDescription_${currentObjectiveIndex}_"]`).value.trim(),
                        status: stratEl.querySelector(`select[name^="strategyStatus_${currentObjectiveIndex}_"]`).value,
                        progress: parseInt(stratEl.querySelector(`input[name^="strategyProgress_${currentObjectiveIndex}_"]`).value) || 0,
                        timeline: stratEl.querySelector(`select[name^="strategyTimeline_${currentObjectiveIndex}_"]`).value,
                        responsible: stratEl.querySelector(`input[name^="strategyResponsible_${currentObjectiveIndex}_"]`).value.trim()
                    };
                    strategicPlanData.push(newItem);
                    itemsAddedInThisSubmission++;
                });
            });

            if (!allValid) return; 
            if (itemsAddedInThisSubmission === 0 && objectiveElements.length > 0) {
                 displayMessage(errorDisplayPlanElement, 'No valid strategies were added. Please ensure all strategy titles are filled.', 'error');
                 return;
            }

            renderStrategicPlan();
            renderObjectiveLegend(planObjectiveLegendElement);
            if (!document.getElementById('gantt-view').classList.contains('view-hidden')) {
                renderGanttChart(); 
            }
            updateSummaryMetrics();
            addPlanFormElement.reset();
            objectivesContainerElement.innerHTML = ''; 
            objectiveCounter = 0; 
            strategyCounter = 0; 
            objectivesContainerElement.appendChild(createObjectiveElement());
            displayMessage(loadingDisplayPlanElement, 'Strategic Priority and its items added to current session.', 'info');
        });

        function deletePlanItemFromMemory(itemId) {
            if (confirm(`Are you sure you want to delete this item from the current view? This change is temporary.`)) {
                strategicPlanData = strategicPlanData.filter(item => item.id !== itemId);
                renderStrategicPlan();
                renderObjectiveLegend(planObjectiveLegendElement); 
                 if (!document.getElementById('gantt-view').classList.contains('view-hidden')) {
                    renderGanttChart(); 
                }
                updateSummaryMetrics();
            }
        }

        // --- Funder Deliverables Functions ---
        function renderFunderDeliverables() {
            displayMessage(loadingDisplayDeliverablesElement, '', 'info');
            funderDeliverablesTableContainerElement.innerHTML = '';

            if (funderDeliverablesData.length === 0) {
                funderDeliverablesTableContainerElement.innerHTML = '<p class="text-gray-500 italic">No funder deliverables added yet.</p>';
                return;
            }

            // Group by funder
            const groupedByFunder = funderDeliverablesData.reduce((acc, item) => {
                const funderName = item.funder || 'Unspecified Funder';
                if (!acc[funderName]) {
                    acc[funderName] = [];
                }
                acc[funderName].push(item);
                return acc;
            }, {});

            let tableHTML = '<table class="min-w-full divide-y divide-gray-200">';
            tableHTML += `
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deliverable</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project/Grant</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due (Quarter)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsible</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;

            for (const funderName in groupedByFunder) {
                // Funder Header Row
                tableHTML += `
                    <tr class="bg-gray-100">
                        <td colspan="7" class="px-6 py-3 text-left text-sm font-semibold text-gray-700">${funderName}</td>
                    </tr>
                `;
                groupedByFunder[funderName].forEach(item => {
                    const statusColorInfo = getStatusColorClasses(item.status);
                    tableHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.title}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.project || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.timeline}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="flex items-center text-xs font-medium px-2 py-0.5 rounded-full ${statusColorInfo.textBg}">
                                    <span class="status-indicator ${statusColorInfo.dot} mr-1.5"></span>
                                    ${item.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.responsible || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 max-w-xs break-words">${item.notes || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="delete-deliverable-btn text-xs text-red-600 hover:text-red-800" data-id="${item.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }
            tableHTML += `</tbody></table>`;
            funderDeliverablesTableContainerElement.innerHTML = tableHTML;

            document.querySelectorAll('.delete-deliverable-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteFunderDeliverableFromMemory(event.target.dataset.id));
            });
        }

        addDeliverableFormElement.addEventListener('submit', (event) => {
            event.preventDefault();
            displayMessage(errorDisplayDeliverablesElement, '', 'info');

            const newDeliverable = {
                id: `fd-manual-${Date.now()}`,
                title: document.getElementById('deliverableTitle').value.trim(),
                funder: document.getElementById('deliverableFunder').value.trim(),
                project: document.getElementById('deliverableProject').value.trim(),
                timeline: document.getElementById('deliverableTimelineQuarter').value, // Changed from dueDate
                status: document.getElementById('deliverableStatus').value,
                responsible: document.getElementById('deliverableResponsible').value.trim(),
                notes: document.getElementById('deliverableNotes').value.trim()
            };

            if (!newDeliverable.title) {
                displayMessage(errorDisplayDeliverablesElement, 'Deliverable Title is required.', 'error');
                return;
            }
            if (!newDeliverable.timeline) {
                displayMessage(errorDisplayDeliverablesElement, 'Due (Quarter) is required for Gantt chart visualization.', 'error');
                // Allow adding, but it won't show on Gantt without a timeline
            }


            funderDeliverablesData.push(newDeliverable);
            renderFunderDeliverables();
            updateSummaryMetrics();
            if (!document.getElementById('gantt-view').classList.contains('view-hidden')) {
                renderGanttChart(); // Update Gantt if visible
            }
            addDeliverableFormElement.reset();
            displayMessage(loadingDisplayDeliverablesElement, 'Funder deliverable added to current session.', 'info');
        });

        function deleteFunderDeliverableFromMemory(deliverableId) {
            if (confirm('Are you sure you want to delete this funder deliverable from the current view? This change is temporary.')) {
                funderDeliverablesData = funderDeliverablesData.filter(item => item.id !== deliverableId);
                renderFunderDeliverables();
                updateSummaryMetrics();
                if (!document.getElementById('gantt-view').classList.contains('view-hidden')) {
                    renderGanttChart(); // Update Gantt if visible
                }
            }
        }


        // --- Initial Load & Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            if(currentYearElement) currentYearElement.textContent = new Date().getFullYear();
            objectivesContainerElement.appendChild(createObjectiveElement()); 
            populateTimelineDropdown(document.getElementById('deliverableTimelineQuarter')); // Populate deliverable timeline

            const planViewLoadingText = document.getElementById('loadingDisplayPlan');
            if(planViewLoadingText) planViewLoadingText.textContent = strategicPlanData.length > 0 ? '' : 'No plan items loaded. Use the form above to add items.';
            
            const deliverablesLoadingText = document.getElementById('loadingDisplayDeliverables');
             if(deliverablesLoadingText) deliverablesLoadingText.textContent = funderDeliverablesData.length > 0 ? '' : 'No funder deliverables loaded. Use the form above to add items.';


            renderStrategicPlan(); 
            renderObjectiveLegend(planObjectiveLegendElement);
            renderFunderDeliverables();
            updateSummaryMetrics();
            switchView('plan'); 
        });
    </script>
</body>
</html>
